---
title: "Gráfico de barras y puntos"
author: "Juan Miguel Rodríguez"
date: "2025-06-12"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(ggplot2)
library(readxl)
library(dplyr)
library(tidyr)

# 1. Cargar datos
df <- read_excel("C:\\Users\\juanr\\OneDrive\\Escritorio\\Beta - Barras y puntos\\Barras y puntos.xlsx")
colnames(df) <- trimws(colnames(df))

# 2. Filtrar clústeres
clusters <- c("San Andrés", "Promedio Cluster 2", "Promedio Cluster 3",
              "Promedio Cluster 4", "Promedio Cluster 5")

df_largo <- df %>%
  filter(Cluster %in% clusters) %>%
  pivot_longer(cols = -c(Cluster, Periodo),
               names_to = "Sector",
               values_to = "Valor") %>%
  mutate(
    Tipo = ifelse(Periodo == "2006 - 2019", "Barra", "Punto"),
    Grupo = gsub("^Promedio ", "", Cluster)  # Quitar "Promedio " si existe
  )

# 3. Establecer orden fijo de sectores basado en San Andrés
orden_fijo <- df_largo %>%
  filter(Cluster == "San Andrés") %>%
  pull(Sector) %>%
  unique()

df_largo$Sector <- factor(df_largo$Sector, levels = orden_fijo)

# 4. Generar y guardar gráfico por grupo
grupos <- unique(df_largo$Grupo)

for (grupo in grupos) {
  datos_grupo <- df_largo %>% filter(Grupo == grupo)
  
  p <- ggplot() +
  geom_col(data = filter(datos_grupo, Tipo == "Barra"),
           aes(x = Valor, y = Sector),
           fill = "#c0d2db", width = 0.6) +  
  geom_point(data = filter(datos_grupo, Tipo == "Punto"),
             aes(x = Valor, y = Sector),
             color = "#1a3d78", size = 3) + 
  scale_x_continuous(breaks = seq(-5, 25, by = 5), limits = c(-5, 25)) +
  labs(
    title = paste("Crecimiento medio por sector –", grupo),
    subtitle = "Barra: 2006 – 2019   |   Punto: 2021 – 2024",
    x = "Tasa de crecimiento promedio (%)",
    y = NULL
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", size = 14, color = "#333333"),
    plot.subtitle = element_text(size = 11, color = "#555555"),
    axis.text = element_text(color = "#333333"),
    axis.title.x = element_text(margin = margin(t = 10)),
    panel.grid.major.y = element_blank(),
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_line(color = "#DDDDDD"),
    plot.background = element_rect(fill = "white", color = NA)
  )

  # Mostrar gráfico
  print(p)
}
```

